<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì €ì¥ëœ ë™í™” - ì‹ ìš°í˜„ì˜ í™ˆí˜ì´ì§€</title>
    <meta name="description" content="ë‚´ê°€ ë§Œë“  ë™í™”ë“¤ì„ ë‹¤ì‹œ ì½ì–´ë³´ì„¸ìš”.">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/fairytale.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“š</text></svg>">
</head>
<body class="page-saved-fairytales">
    <nav>
        <div class="nav-container">
            <a href="index.html" class="logo">ì‹ ìš°í˜„</a>
            <ul class="nav-links">
                <li><a href="index.html">í™ˆ</a></li>
                <li><a href="baseball.html">í”„ë¡œì•¼êµ¬</a></li>
                <li><a href="baduk.html">ë°”ë‘‘</a></li>
                <li><a href="game.html">ê²Œì„</a></li>
                <li><a href="game2.html">ê²Œì„2</a></li>
                <li><a href="moon.html">ë‚ ì”¨ Â· ë‹¬</a></li>
                <li><a href="fairytale.html">ë™í™” ë§Œë“¤ê¸°</a></li>
                <li><a href="typing.html">íƒ€ìì—°ìŠµ</a></li>
                <li><a href="letters.html">í¸ì§€ì“°ê¸°</a></li>
                <li><a href="passwordgame.html">íŒ¨ìŠ¤ì›Œë“œ ê²Œì„</a></li>
                <li><a href="saved-fairytales.html" class="active">ì €ì¥ëœ ë™í™”</a></li>
            </ul>
            <div class="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <main>
        <section class="section" id="saved-fairytales">
            <div class="container">
                <div class="page-header">
                    <h1>ğŸ“š ì €ì¥ëœ ë™í™”</h1>
                    <p>ë‚´ê°€ ë§Œë“  ì†Œì¤‘í•œ ë™í™”ë“¤ì„ ë‹¤ì‹œ ì½ì–´ë³´ì„¸ìš”.</p>
                </div>

                <div class="card" style="text-align: center; margin-bottom: 2rem;">
                    <p id="loading-message">ë™í™” ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    <p id="empty-message" style="display: none;">ì•„ì§ ì €ì¥ëœ ë™í™”ê°€ ì—†ìŠµë‹ˆë‹¤. <a href="fairytale.html">ë™í™” ë§Œë“¤ëŸ¬ ê°€ê¸°</a></p>
                </div>

                <div id="fairytales-list" class="card-grid"></div>
            </div>
        </section>

        <section class="section">
            <div class="container" style="text-align: center;">
                <a href="fairytale.html" class="btn">ğŸ“– ìƒˆ ë™í™” ë§Œë“¤ê¸°</a>
                <a href="index.html" class="btn btn-secondary">ğŸ  í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>&copy; ì‹ ìš°í˜„ì˜ í™ˆí˜ì´ì§€. ìƒìƒë ¥ì„ ë§ˆìŒê» í¼ì³ë³´ì„¸ìš”! ğŸ“–</p>
        </div>
    </footer>

    <script src="js/script.js"></script>
    <script type="module">
        import { db } from './js/firebase-fairytale-config.js';
        import { collection, query, orderBy, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const loadingMessage = document.getElementById('loading-message');
        const emptyMessage = document.getElementById('empty-message');
        const fairytalesList = document.getElementById('fairytales-list');

        async function loadFairytales() {
            try {
                const q = query(collection(db, 'fairytales'), orderBy('createdAt', 'desc'));
                const querySnapshot = await getDocs(q);

                loadingMessage.style.display = 'none';

                if (querySnapshot.empty) {
                    emptyMessage.style.display = 'block';
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const fairytaleCard = createFairytaleCard(doc.id, data);
                    fairytalesList.appendChild(fairytaleCard);
                });

            } catch (error) {
                console.error('ë™í™” ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
                loadingMessage.textContent = 'ë™í™”ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                loadingMessage.style.color = 'red';
            }
        }

        function createFairytaleCard(id, data) {
            const card = document.createElement('article');
            card.className = 'card fairytale-card';
            card.style.cursor = 'pointer';

            const date = data.createdAt ? new Date(data.createdAt.toDate()).toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }) : 'ë‚ ì§œ ì—†ìŒ';

            const moodLabels = {
                'warm': 'ë”°ëœ»í•œ',
                'moral': 'êµí›ˆì ì¸',
                'humorous': 'ìœ ë¨¸ëŸ¬ìŠ¤í•œ'
            };
            const moodText = moodLabels[data.mood] || data.mood;

            // í‚¤ì›Œë“œ ë°°ì—´ì„ ë¬¸ìì—´ë¡œ ë³€í™˜
            let keywordsText = '';
            if (Array.isArray(data.keywords)) {
                keywordsText = data.keywords.filter(k => k).join(', ');
            } else if (typeof data.keywords === 'object') {
                keywordsText = Object.values(data.keywords).filter(k => k).join(', ');
            }

            const contentPreview = data.content.length > 150
                ? data.content.substring(0, 150) + '...'
                : data.content;

            card.innerHTML = `
                <div class="fairytale-header">
                    <span class="fairytale-date">ğŸ“… ${date}</span>
                    <span class="fairytale-mood">ğŸ­ ${moodText}</span>
                </div>
                ${keywordsText ? `<p class="fairytale-keywords"><strong>í‚¤ì›Œë“œ:</strong> ${keywordsText}</p>` : ''}
                <div class="fairytale-preview">
                    <p>${contentPreview}</p>
                </div>
                <div class="fairytale-full" style="display: none;">
                    <p>${data.content}</p>
                </div>
                <button class="btn btn-secondary toggle-content" style="margin-top: 1rem;">ì „ì²´ ë³´ê¸°</button>
            `;

            const toggleBtn = card.querySelector('.toggle-content');
            const preview = card.querySelector('.fairytale-preview');
            const full = card.querySelector('.fairytale-full');

            toggleBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (full.style.display === 'none') {
                    preview.style.display = 'none';
                    full.style.display = 'block';
                    toggleBtn.textContent = 'ì ‘ê¸°';
                } else {
                    preview.style.display = 'block';
                    full.style.display = 'none';
                    toggleBtn.textContent = 'ì „ì²´ ë³´ê¸°';
                }
            });

            return card;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë™í™” ë¶ˆëŸ¬ì˜¤ê¸°
        loadFairytales();
    </script>
</body>
</html>
